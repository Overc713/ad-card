<!DOCTYPE html>
<html>
<head>
    <title>AR名片修复版</title>
    <meta charset="UTF-8">
    <style>
        body { 
            margin: 0;
            overflow: hidden;
        }
        #arButton {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            z-index: 999;
        }
    </style>
</head>
<body>
    <button id="arButton">进入AR模式</button>

<script type="module">
import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
import { WebXRManager } from 'https://cdn.skypack.dev/three@0.136.0/src/renderers/webxr/WebXRManager.js';
import { GLTFLoader } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/loaders/GLTFLoader.js';

// 初始化场景
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ 
    antialias: true,
    alpha: true // 关键修复：启用透明背景
});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.xr.enabled = true; // 提前启用XR支持
document.body.appendChild(renderer.domElement);

// 添加光源（必须步骤）
const light = new THREE.AmbientLight(0xffffff, 1);
scene.add(light);

let currentSession = null;

async function startAR() {
    try {
        // 兼容性检测
        if (!navigator.xr) {
            alert("请使用最新版Chrome或Safari浏览器");
            return;
        }

        // 请求AR会话
        const session = await navigator.xr.requestSession('immersive-ar', {
            requiredFeatures: ['local', 'hit-test']
        });
        
        currentSession = session;
        
        // 正确初始化WebXR
        renderer.xr.setReferenceSpaceType('local');
        await renderer.xr.setSession(session);
        
        // 移除背景设置（自动使用摄像头画面）
        
        // 添加点击事件
        session.addEventListener('select', placeObject);
        
        document.getElementById('arButton').style.display = 'none';
        
    } catch (error) {
        alert(`AR启动失败: ${error.message}`);
    }
}

// 放置物体函数
let arObject = null;

async function placeObject() {
    if (!arObject) {
        const geometry = new THREE.BoxGeometry(0.3, 0.3, 0.3);
        const material = new THREE.MeshPhongMaterial({ 
            color: 0x00ff00,
            transparent: true,
            opacity: 0.8
        });
        arObject = new THREE.Mesh(geometry, material);
        scene.add(arObject);
    }
    
    const referenceSpace = renderer.xr.getReferenceSpace();
    const ray = new XRRay(new DOMPoint(0, 0, 0));
    
    const hitTestResults = await session.requestHitTest(ray, referenceSpace);
    if (hitTestResults.length > 0) {
        const hit = hitTestResults[0];
        const pose = hit.getPose(referenceSpace);
        arObject.position.set(
            pose.transform.position.x,
            pose.transform.position.y,
            pose.transform.position.z
        );
    }
}

// 按钮绑定
document.getElementById('arButton').addEventListener('click', startAR);

// 响应式处理
window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

// 动画循环
renderer.setAnimationLoop(() => {
    if (arObject) {
        arObject.rotation.y += 0.01;
    }
    renderer.render(scene, camera);
});
</script>
</body>
</html>
